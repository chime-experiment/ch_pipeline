

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ch_pipeline.analysis.beam &mdash; ch_pipeline  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ch_pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev.html">Development Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ch_pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ch_pipeline.analysis.beam</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ch_pipeline.analysis.beam</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Tasks for beam measurement processing.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">listdir</span><span class="p">,</span> <span class="n">path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">caput</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">mpiarray</span><span class="p">,</span> <span class="n">mpiutil</span><span class="p">,</span> <span class="n">tod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">caput.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">PipelineRuntimeError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">caput.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">STELLAR_S</span><span class="p">,</span> <span class="n">unix_to_datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ch_ephem</span><span class="w"> </span><span class="kn">import</span> <span class="n">sources</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ch_ephem.observers</span><span class="w"> </span><span class="kn">import</span> <span class="n">chime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ch_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">holography</span><span class="p">,</span> <span class="n">tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chimedb.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect</span> <span class="k">as</span> <span class="n">connect_database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">draco.analysis.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">Regridder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">draco.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">draco.core.containers</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContainerBase</span><span class="p">,</span> <span class="n">SiderealStream</span><span class="p">,</span> <span class="n">TimeStream</span><span class="p">,</span> <span class="n">TrackBeam</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">draco.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">regrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">draco.util.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">invert_no_zero</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..core.containers</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransitFitParams</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransitFit</span>

<span class="n">SIDEREAL_DAY_SEC</span> <span class="o">=</span> <span class="n">STELLAR_S</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
<span class="n">SPEED_LIGHT</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c1"># 10^6 m / s</span>
<span class="n">CHIME_CYL_W</span> <span class="o">=</span> <span class="mf">22.0</span>  <span class="c1"># m</span>


<div class="viewcode-block" id="TransitGrouper">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitGrouper">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransitGrouper</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group transits from a sequence of TimeStream objects.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    ha_span: float</span>
<span class="sd">        Span in degrees surrounding transit.</span>
<span class="sd">    min_span: float</span>
<span class="sd">        Minimum span (deg) of a transit to accept.</span>
<span class="sd">    source: str</span>
<span class="sd">        Name of the transiting source. (Must match what is used in `ch_ephem.sources`.)</span>
<span class="sd">    db_source: str</span>
<span class="sd">        Name of the transiting source as listed in holography database.</span>
<span class="sd">        This is a hack until a better solution is implemented.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ha_span</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">180.0</span><span class="p">)</span>
    <span class="n">min_span</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">db_source</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="TransitGrouper.setup">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitGrouper.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the local observers position if not using CHIME.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        observer : caput.time.Observer, optional</span>
<span class="sd">            Details of the observer, if not set default to CHIME.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        `caput.config.CaputConfigError`</span>
<span class="sd">            If config value ``source`` doesn&#39;t match any in `ch_ephem.sources`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">chime</span> <span class="k">if</span> <span class="n">observer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">observer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">source_dictionary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find source &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; in &quot;</span>
                <span class="s2">&quot;`ch_ephem.sources.source_dictionary`.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">config</span><span class="o">.</span><span class="n">CaputConfigError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get list of holography observations</span>
        <span class="c1"># Only allowed to query database from rank0</span>
        <span class="n">db_runs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mpiutil</span><span class="o">.</span><span class="n">rank0</span><span class="p">:</span>
            <span class="n">connect_database</span><span class="p">()</span>
            <span class="n">db_runs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_holography_obs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_source</span><span class="p">))</span>
            <span class="n">db_runs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">finish_time</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">db_runs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_runs</span> <span class="o">=</span> <span class="n">mpiutil</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">db_runs</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mpiutil</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span></div>


<div class="viewcode-block" id="TransitGrouper.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitGrouper.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstream</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take in a timestream and accumulate, group into whole transits.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tstream : TimeStream</span>
<span class="sd">            timestream data container</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ts : TimeStream</span>
<span class="sd">            Timestream with containing transits of specified length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Redistribute if needed</span>
        <span class="n">tstream</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># placeholder for finalized transit when it is ready</span>
        <span class="n">final_ts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># check if we jumped to another acquisition</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># will be true when we start a new transit</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># start on a new transit and return current one</span>
                <span class="n">final_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_transit</span><span class="p">()</span>

        <span class="c1"># if this is the start of a new grouping, setup transit bounds</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">transit_times</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr_time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Didn&#39;t find exactly one transit time. Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_time</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="o">=</span> <span class="n">tr_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transit_bounds</span><span class="p">()</span>

        <span class="c1"># check if we&#39;ve accumulated enough past the transit</span>
        <span class="k">if</span> <span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tstream</span><span class="p">)</span>
            <span class="n">final_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_transit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tstream</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_time</span> <span class="o">=</span> <span class="n">tstream</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">final_ts</span></div>


<div class="viewcode-block" id="TransitGrouper.process_finish">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitGrouper.process_finish">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current transit before finishing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ts: TimeStream</span>
<span class="sd">            Last (possibly incomplete) transit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_transit</span><span class="p">()</span></div>


<div class="viewcode-block" id="TransitGrouper.append">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitGrouper.append">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a timestream to the buffer list.</span>

<span class="sd">        This will strip eigenvector datasets if they are present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;evec&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">,</span> <span class="s2">&quot;erms&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dname</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stripping dataset </span><span class="si">{</span><span class="n">dname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">ts</span><span class="p">[</span><span class="n">dname</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_transit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concatenate grouped time streams for the currrent transit.&quot;&quot;&quot;</span>
        <span class="c1"># Find where transit starts and ends</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Did not find any transits.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finalising transit for </span><span class="si">{</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span><span class="p">)</span><span class="si">}</span><span class="s2">...&quot;</span>
        <span class="p">)</span>
        <span class="n">all_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ts</span><span class="o">.</span><span class="n">time</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">])</span>
        <span class="n">start_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)))</span>
        <span class="n">stop_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">all_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)))</span>

        <span class="c1"># Save list of filenames</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">]</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Time steps are not positive definite: dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; Skipping.&quot;</span>
            <span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">stop_ind</span> <span class="o">-</span> <span class="n">start_ind</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_span</span> <span class="o">/</span> <span class="mf">360.0</span> <span class="o">*</span> <span class="n">SIDEREAL_DAY_SEC</span> <span class="o">/</span> <span class="n">dt</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Concatenate timestreams</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">tod</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_ind</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_ind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">object_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">all_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;source_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;transit_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;observation_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_id</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{:0&gt;4d}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_id</span><span class="p">,</span>
                <span class="n">unix_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;archivefiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filenames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transit too short. Skipping.&quot;</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tstreams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_transit_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the start and end times of this transit.</span>

<span class="sd">        Compares the desired HA span to the start and end times of the observation</span>
<span class="sd">        recorded in the database. Also gets the observation ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># subtract half a day from start time to ensure we don&#39;t get following day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha_span</span> <span class="o">/</span> <span class="mf">360.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">SIDEREAL_DAY_SEC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha_span</span> <span class="o">/</span> <span class="mf">360.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">SIDEREAL_DAY_SEC</span>

        <span class="c1"># get bounds of observation from database</span>
        <span class="n">this_run</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">r</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_runs</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_run</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find source transit in holography database for </span><span class="si">{</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># skip this file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_transit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">,</span> <span class="n">this_run</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">,</span> <span class="n">this_run</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_id</span> <span class="o">=</span> <span class="n">this_run</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="TransitRegridder">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitRegridder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransitRegridder</span><span class="p">(</span><span class="n">Regridder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolate TimeStream transits onto a regular grid in hour angle.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    samples : int</span>
<span class="sd">        Number of samples to interpolate onto.</span>
<span class="sd">    ha_span: float</span>
<span class="sd">        Span in degrees surrounding transit.</span>
<span class="sd">    lanczos_width : int</span>
<span class="sd">        Width of the Lanczos interpolation kernel.</span>
<span class="sd">    snr_cov: float</span>
<span class="sd">        Ratio of signal covariance to noise covariance (used for Wiener filter).</span>
<span class="sd">    source: str</span>
<span class="sd">        Name of the transiting source. (Must match what is used in `ch_ephem.sources`.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">lanczos_width</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">snr_cov</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
    <span class="n">ha_span</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">180.0</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="TransitRegridder.setup">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitRegridder.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the local observers position if not using CHIME.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        observer : caput.time.Observer, optional</span>
<span class="sd">            Details of the observer, if not set default to CHIME.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        `caput.config.CaputConfigError`</span>
<span class="sd">            If config value ``source`` doesn&#39;t match any in `ch_ephem.sources`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">chime</span> <span class="k">if</span> <span class="n">observer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">observer</span>

        <span class="c1"># Setup bounds for interpolation grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ha_span</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ha_span</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">source_dictionary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find source &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; in &quot;</span>
                <span class="s2">&quot;`ch_ephem.sources.source_dictionary`.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">config</span><span class="o">.</span><span class="n">CaputConfigError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="TransitRegridder.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitRegridder.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Regrid visibility data onto a regular grid in hour angle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : TimeStream</span>
<span class="sd">            Time-ordered data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_data : SiderealStream</span>
<span class="sd">            The regridded data centered on the source RA.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Redistribute if needed</span>
        <span class="n">data</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># View of data</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">vis_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">vis</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="c1"># Get apparent source RA, including precession effects</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">object_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Get catalogue RA for reference</span>
        <span class="n">ra_icrs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">object_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert input times to hour angle</span>
        <span class="n">lha</span> <span class="o">=</span> <span class="n">unwrap_lha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">unix_to_lsa</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">ra</span><span class="p">)</span>

        <span class="c1"># perform regridding</span>
        <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_grid</span><span class="p">,</span> <span class="n">new_vis</span><span class="p">,</span> <span class="n">ni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regrid</span><span class="p">(</span><span class="n">vis_data</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">lha</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Check other ranks have completed</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">mpiutil</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span> <span class="o">!=</span> <span class="n">mpiutil</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Regridding failed. Skipping transit.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># mask out regions beyond bounds of this transit</span>
        <span class="n">grid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">new_grid</span><span class="p">)</span>
        <span class="n">grid_mask</span><span class="p">[</span><span class="n">new_grid</span> <span class="o">&lt;</span> <span class="n">lha</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">grid_mask</span><span class="p">[</span><span class="n">new_grid</span> <span class="o">&gt;</span> <span class="n">lha</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_vis</span> <span class="o">*=</span> <span class="n">grid_mask</span>
        <span class="n">ni</span> <span class="o">*=</span> <span class="n">grid_mask</span>

        <span class="c1"># Wrap to produce MPIArray</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="p">:</span>
            <span class="n">new_vis</span> <span class="o">=</span> <span class="n">mpiarray</span><span class="o">.</span><span class="n">MPIArray</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">new_vis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vis</span><span class="o">.</span><span class="n">distributed_axis</span><span class="p">)</span>
            <span class="n">ni</span> <span class="o">=</span> <span class="n">mpiarray</span><span class="o">.</span><span class="n">MPIArray</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">vis</span><span class="o">.</span><span class="n">distributed_axis</span><span class="p">)</span>

        <span class="c1"># Create new container for output</span>
        <span class="n">ra_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_grid</span> <span class="o">+</span> <span class="n">ra</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.0</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">SiderealStream</span><span class="p">(</span>
            <span class="n">axes_from</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">attrs_from</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="n">ra_grid</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">comm</span>
        <span class="p">)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">vis</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_vis</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ni</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cirs_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;icrs_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra_icrs</span>

        <span class="k">return</span> <span class="n">new_data</span></div>
</div>



<div class="viewcode-block" id="EdgeFlagger">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.EdgeFlagger">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EdgeFlagger</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag the edges of the transit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_begin: int</span>
<span class="sd">        Number of samples to flag at the start of the transit.</span>
<span class="sd">    num_end: int</span>
<span class="sd">        Number of samples to flag at the end of the transit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_begin</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">num_end</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<div class="viewcode-block" id="EdgeFlagger.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.EdgeFlagger.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extend the region that has weight set to zero.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        track: draco.core.containers.TrackBeam</span>
<span class="sd">            Holography track to flag.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        track: draco.core.containers.TrackBeam</span>
<span class="sd">            Holography track with weight set to zero for</span>
<span class="sd">            `num_begin` samples at the start of the transit</span>
<span class="sd">            and `num_end` samples at the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_begin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">track</span>

        <span class="n">track</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="n">weight</span> <span class="o">=</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="o">*</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">imax</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_begin</span><span class="p">:</span>
                    <span class="n">weight</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">imin</span> <span class="p">:</span> <span class="n">imin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_begin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_end</span><span class="p">:</span>
                    <span class="n">weight</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">imax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_end</span> <span class="p">:</span> <span class="n">imax</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">track</span></div>
</div>



<div class="viewcode-block" id="TransitResampler">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitResampler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransitResampler</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resample the beam at specific RAs.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    lanczos_width : int</span>
<span class="sd">        Width of the Lanczos kernel in number of samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lanczos_width</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<div class="viewcode-block" id="TransitResampler.setup">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitResampler.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the local observers position if not using CHIME.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        observer : caput.time.Observer, optional</span>
<span class="sd">            Details of the observer, if not set default to CHIME.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">chime</span> <span class="k">if</span> <span class="n">observer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">observer</span></div>


<div class="viewcode-block" id="TransitResampler.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitResampler.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample the measured beam at arbitrary RA by convolving with a Lanczos kernel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beam : draco.core.containers.TrackBeam</span>
<span class="sd">            The beam that will be resampled.</span>
<span class="sd">        data : draco.core.containers.VisContainer</span>
<span class="sd">            Must contain a `time` or `ra` axis that defines</span>
<span class="sd">            the RAs to sample.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_beam : draco.core.containers.TrackBeam</span>
<span class="sd">             The input `beam` re-sampled at the RAs contained in `data`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Distribute over frequencies</span>
        <span class="n">data</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>
        <span class="n">beam</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># Dereference datasets</span>
        <span class="n">bv</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bw</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Compute the hour angle of the source</span>
        <span class="k">if</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index_map</span><span class="p">:</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">][:]</span>
        <span class="k">elif</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index_map</span><span class="p">:</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">unix_to_lsa</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unable to extract RA from input container.&quot;</span><span class="p">)</span>

        <span class="n">hour_angle</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">][:]</span>

        <span class="n">new_hour_angle</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ra</span> <span class="o">-</span> <span class="n">beam</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cirs_ra&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">180.0</span>

        <span class="n">isort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">new_hour_angle</span><span class="p">)</span>
        <span class="n">new_hour_angle_sorted</span> <span class="o">=</span> <span class="n">new_hour_angle</span><span class="p">[</span><span class="n">isort</span><span class="p">]</span>

        <span class="n">within_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span>
            <span class="p">(</span><span class="n">new_hour_angle_sorted</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">hour_angle</span><span class="p">[</span><span class="n">flag</span><span class="p">]))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_hour_angle_sorted</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hour_angle</span><span class="p">[</span><span class="n">flag</span><span class="p">]))</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">within_range</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanczos_width</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not enough overlapping samples.&quot;</span><span class="p">)</span>

        <span class="n">slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">within_range</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanczos_width</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">within_range</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lanczos_width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Perform regridding</span>
        <span class="n">new_bv</span><span class="p">,</span> <span class="n">new_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resample</span><span class="p">(</span><span class="n">hour_angle</span><span class="p">,</span> <span class="n">bv</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">new_hour_angle_sorted</span><span class="p">[</span><span class="n">slc</span><span class="p">])</span>

        <span class="c1"># Create output container</span>
        <span class="n">new_beam</span> <span class="o">=</span> <span class="n">TrackBeam</span><span class="p">(</span>
            <span class="n">phi</span><span class="o">=</span><span class="n">new_hour_angle</span><span class="p">,</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">][:]),</span> <span class="n">new_hour_angle</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
            <span class="n">axes_from</span><span class="o">=</span><span class="n">beam</span><span class="p">,</span>
            <span class="n">attrs_from</span><span class="o">=</span><span class="n">beam</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">beam</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
            <span class="n">comm</span><span class="o">=</span><span class="n">beam</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">new_beam</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># Save to container</span>
        <span class="n">new_beam</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_beam</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">new_beam</span><span class="o">.</span><span class="n">beam</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">isort</span><span class="p">[</span><span class="n">slc</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_bv</span>
        <span class="n">new_beam</span><span class="o">.</span><span class="n">weight</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">isort</span><span class="p">[</span><span class="n">slc</span><span class="p">]]</span> <span class="o">=</span> <span class="n">new_bw</span>

        <span class="k">return</span> <span class="n">new_beam</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">wgrid</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">lza</span> <span class="o">=</span> <span class="n">regrid</span><span class="o">.</span><span class="n">lanczos_forward_matrix</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lanczos_width</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">ygrid</span><span class="p">,</span> <span class="n">lza</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">invert_no_zero</span><span class="p">(</span><span class="n">wgrid</span><span class="p">),</span> <span class="n">lza</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span></div>



<div class="viewcode-block" id="MakeHolographyBeam">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.MakeHolographyBeam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MakeHolographyBeam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Repackage a holography transit into a beam container.</span>

<span class="sd">    The visibilities will be grouped according to their respective 26 m</span>
<span class="sd">    input (along the `pol` axis, labelled by the 26 m polarisation of that input).</span>

<span class="sd">    The form of the beam dataset is A_{i} = &lt; E_{i} * E_{26m}^{*} &gt;, i.e. the 26m</span>
<span class="sd">    input is the conjugate part of the visbility.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MakeHolographyBeam.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.MakeHolographyBeam.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">inputmap</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Package a holography transit into a beam container.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : SiderealStream</span>
<span class="sd">            Transit observation as generated by `TransitRegridder`.</span>
<span class="sd">        inputmap : list of `CorrInput`</span>
<span class="sd">            A list describing the inputs as they are in the file, output from</span>
<span class="sd">            `ch_util.tools.get_correlator_inputs()`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        track : TrackBeam</span>
<span class="sd">            The transit in a beam container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># redistribute if needed</span>
        <span class="n">data</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="n">prod</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>

        <span class="c1"># Figure out which inputs are the 26m</span>
        <span class="n">input_26m</span> <span class="o">=</span> <span class="n">prod</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">prod</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_26m</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Did not find exactly two 26m inputs in the data.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PipelineRuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Separate products by 26 m inputs</span>
        <span class="n">prod_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_26m</span><span class="p">:</span>
            <span class="n">prod_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">prod</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Check we have the expected number of products</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">prod_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="ow">or</span> <span class="n">prod_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Products do not separate into two groups with the length of the input map. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">prod_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">prod_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">) != </span><span class="si">{</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PipelineRuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Sort based on the id in the layout database</span>
        <span class="n">corr_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">inp</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputmap</span><span class="p">])</span>
        <span class="n">isort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">corr_id</span><span class="p">)</span>

        <span class="c1"># Create new input axis using id and serial number in database</span>
        <span class="n">inputs_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">inputmap</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">inputmap</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">input_sn</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">isort</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Sort the products based on the input id in database and</span>
        <span class="c1"># determine which products should be conjugated.</span>
        <span class="n">conj</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prod_groups_sorted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prod_groups</span><span class="p">):</span>
            <span class="n">group_prod</span> <span class="o">=</span> <span class="n">prod</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
            <span class="n">group_conj</span> <span class="o">=</span> <span class="n">group_prod</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_26m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">group_inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">group_conj</span><span class="p">,</span> <span class="n">group_prod</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">],</span> <span class="n">group_prod</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">group_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">corr_id</span><span class="p">[</span><span class="n">group_inputs</span><span class="p">])</span>

            <span class="n">prod_groups_sorted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="n">group_sort</span><span class="p">])</span>
            <span class="n">conj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_conj</span><span class="p">[</span><span class="n">group_sort</span><span class="p">])</span>

        <span class="c1"># Regroup by co/cross-pol</span>
        <span class="n">copol</span><span class="p">,</span> <span class="n">xpol</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">prod_groups_cox</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">prod_groups_sorted</span><span class="p">]</span>
        <span class="n">conj_cox</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">conj</span><span class="p">]</span>
        <span class="n">input_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">ipt</span><span class="o">.</span><span class="n">pol</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">is_array</span><span class="p">(</span><span class="n">ipt</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tools</span><span class="o">.</span><span class="n">is_holographic</span><span class="p">(</span><span class="n">ipt</span><span class="p">))</span>
                    <span class="k">else</span> <span class="n">inputmap</span><span class="p">[</span><span class="n">input_26m</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">pol</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">ipt</span> <span class="ow">in</span> <span class="n">inputmap</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prod_groups_sorted</span><span class="p">):</span>
            <span class="n">group_prod</span> <span class="o">=</span> <span class="n">prod</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
            <span class="c1"># Determine co/cross in each prod group</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">input_pol</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">conj</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">group_prod</span><span class="p">[</span><span class="s2">&quot;input_b&quot;</span><span class="p">],</span> <span class="n">group_prod</span><span class="p">[</span><span class="s2">&quot;input_a&quot;</span><span class="p">])</span>
                <span class="p">]</span>
                <span class="o">==</span> <span class="n">inputmap</span><span class="p">[</span><span class="n">input_26m</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">pol</span>
            <span class="p">)</span>
            <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
            <span class="n">copol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
            <span class="n">xpol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xp</span><span class="p">)</span>
            <span class="c1"># Move products to co/cross-based groups</span>
            <span class="n">prod_groups_cox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span>
            <span class="n">prod_groups_cox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">xp</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg</span><span class="p">[</span><span class="n">xp</span><span class="p">]</span>
            <span class="n">conj_cox</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">conj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cp</span><span class="p">]</span>
            <span class="n">conj_cox</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">xp</span><span class="p">]</span> <span class="o">=</span> <span class="n">conj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">xp</span><span class="p">]</span>
        <span class="c1"># Check for compeleteness</span>
        <span class="n">consistent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">copol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">copol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">copol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">xpol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">xpol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">xpol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">consistent</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Products do not separate exclusively into co- and cross-polar groups.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PipelineRuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Make new index map</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cirs_ra&quot;</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">unwrap_lha</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ra</span><span class="p">[:],</span> <span class="n">ra</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;dec&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Input stream must have a &#39;dec&#39; attribute specifying &quot;</span>
                <span class="s2">&quot;declination of holography source.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PipelineRuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span>
        <span class="n">pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;co&quot;</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S5&quot;</span><span class="p">)</span>

        <span class="c1"># Create new container and fill</span>
        <span class="n">track</span> <span class="o">=</span> <span class="n">TrackBeam</span><span class="p">(</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
            <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
            <span class="n">track_type</span><span class="o">=</span><span class="s2">&quot;drift&quot;</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="s2">&quot;celestial&quot;</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">inputs_sorted</span><span class="p">,</span>
            <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">freq</span><span class="p">[:],</span>
            <span class="n">attrs_from</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pol</span><span class="p">)):</span>
            <span class="n">track</span><span class="o">.</span><span class="n">beam</span><span class="p">[:,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">vis</span><span class="p">[:,</span> <span class="n">prod_groups_cox</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">track</span><span class="o">.</span><span class="n">weight</span><span class="p">[:,</span> <span class="n">ip</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">weight</span><span class="p">[:,</span> <span class="n">prod_groups_cox</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">conj_cox</span><span class="p">[</span><span class="n">ip</span><span class="p">]):</span>
                <span class="n">track</span><span class="o">.</span><span class="n">beam</span><span class="p">[:,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">conj_cox</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">beam</span><span class="p">[</span>
                    <span class="p">:,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">conj_cox</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span> <span class="p">:</span>
                <span class="p">]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="c1"># Store 26 m inputs</span>
        <span class="n">track</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;26m_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">isort</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">input_26m</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">track</span></div>
</div>



<div class="viewcode-block" id="ConstructStackedBeam">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.ConstructStackedBeam">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConstructStackedBeam</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the effective beam for stacked baselines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weight : string (&#39;uniform&#39; or &#39;inverse_variance&#39;)</span>
<span class="sd">        How to weight the baselines when stacking:</span>
<span class="sd">            &#39;uniform&#39; - each baseline given equal weight</span>
<span class="sd">            &#39;inverse_variance&#39; - each baseline weighted by the weight attribute</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">enum</span><span class="p">([</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_variance&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ConstructStackedBeam.setup">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.ConstructStackedBeam.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the Telescope instance to use.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tel : TransitTelescope</span>
<span class="sd">            telescope object to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">get_telescope</span><span class="p">(</span><span class="n">tel</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConstructStackedBeam.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.ConstructStackedBeam.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stack.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beam : TrackBeam</span>
<span class="sd">            The beam that will be stacked.</span>
<span class="sd">        data : VisContainer</span>
<span class="sd">            Must contain `prod` index map and `stack` reverse map</span>
<span class="sd">            that will be used to stack the beam.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stacked_beam: VisContainer</span>
<span class="sd">            The input `beam` stacked in the same manner as</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Distribute over frequencies</span>
        <span class="n">data</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>
        <span class="n">beam</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># Grab the stack specifications from the input sidereal stream</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;prod&quot;</span><span class="p">]</span>
        <span class="n">reverse_stack</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reverse_map</span><span class="p">[</span><span class="s2">&quot;stack&quot;</span><span class="p">][:]</span>

        <span class="n">input_flags</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">input_flags</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">input_flags</span><span class="p">):</span>
            <span class="n">input_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">input_flags</span><span class="p">)</span>

        <span class="c1"># Create output container</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SiderealStream</span><span class="p">):</span>
            <span class="n">OutputContainer</span> <span class="o">=</span> <span class="n">SiderealStream</span>
            <span class="n">output_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">ra</span><span class="p">[:]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">OutputContainer</span> <span class="o">=</span> <span class="n">TimeStream</span>
            <span class="n">output_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[:]}</span>

        <span class="n">stacked_beam</span> <span class="o">=</span> <span class="n">OutputContainer</span><span class="p">(</span>
            <span class="n">axes_from</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">attrs_from</span><span class="o">=</span><span class="n">beam</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comm</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
            <span class="o">**</span><span class="n">output_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">stacked_beam</span><span class="o">.</span><span class="n">vis</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">stacked_beam</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">stacked_beam</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">beam</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]])</span>

        <span class="c1"># Dereference datasets</span>
        <span class="n">bv</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="n">ov</span> <span class="o">=</span> <span class="n">stacked_beam</span><span class="o">.</span><span class="n">vis</span><span class="p">[:]</span>
        <span class="n">ow</span> <span class="o">=</span> <span class="n">stacked_beam</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span>

        <span class="n">pol_filter</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
            <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;co&quot;</span><span class="p">:</span> <span class="s2">&quot;co&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cross&quot;</span><span class="p">:</span> <span class="s2">&quot;cross&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">pol</span> <span class="o">=</span> <span class="p">[</span><span class="n">pol_filter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="o">.</span><span class="n">polarisation</span><span class="p">]</span>
        <span class="n">beam_pol</span> <span class="o">=</span> <span class="p">[</span><span class="n">pol_filter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">beam</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">][:]]</span>

        <span class="c1"># Compute the fractional variance of the beam measurement</span>
        <span class="n">frac_var</span> <span class="o">=</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">bw</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bv</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Create counter to increment during the stacking.</span>
        <span class="c1"># This will be used to normalize at the end.</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ow</span><span class="p">)</span>

        <span class="c1"># Construct stack</span>
        <span class="k">for</span> <span class="n">pp</span><span class="p">,</span> <span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">conj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reverse_stack</span><span class="p">):</span>
            <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">prod</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">conj</span><span class="p">:</span>
                <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">bb</span><span class="p">,</span> <span class="n">aa</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">aa_pol</span><span class="p">,</span> <span class="n">bb_pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_pol</span><span class="p">(</span><span class="n">pol</span><span class="p">[</span><span class="n">aa</span><span class="p">],</span> <span class="n">pol</span><span class="p">[</span><span class="n">bb</span><span class="p">],</span> <span class="n">beam_pol</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">cross</span> <span class="o">=</span> <span class="n">bv</span><span class="p">[:,</span> <span class="n">aa_pol</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">bv</span><span class="p">[:,</span> <span class="n">bb_pol</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

            <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">input_flags</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">input_flags</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">invert_no_zero</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">frac_var</span><span class="p">[:,</span> <span class="n">aa_pol</span><span class="p">,</span> <span class="n">aa</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">frac_var</span><span class="p">[:,</span> <span class="n">bb_pol</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="s2">&quot;inverse_variance&quot;</span><span class="p">:</span>
                <span class="n">wss</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wss</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># Accumulate variances in quadrature.  Save in the weight dataset.</span>
            <span class="n">ov</span><span class="p">[:,</span> <span class="n">ss</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">wss</span> <span class="o">*</span> <span class="n">cross</span>
            <span class="n">ow</span><span class="p">[:,</span> <span class="n">ss</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">wss</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

            <span class="c1"># Increment counter</span>
            <span class="n">counter</span><span class="p">[:,</span> <span class="n">ss</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">wss</span>

        <span class="c1"># Divide through by counter to get properly weighted visibility average</span>
        <span class="n">ov</span><span class="p">[:]</span> <span class="o">*=</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
        <span class="n">ow</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">counter</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">ow</span><span class="p">[:])</span>

        <span class="k">return</span> <span class="n">stacked_beam</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_pol</span><span class="p">(</span><span class="n">pol1</span><span class="p">,</span> <span class="n">pol2</span><span class="p">,</span> <span class="n">pol_axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;co&quot;</span> <span class="ow">in</span> <span class="n">pol_axis</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pol1</span> <span class="o">==</span> <span class="n">pol2</span><span class="p">:</span>
                <span class="n">ipol</span> <span class="o">=</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;co&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ipol</span> <span class="o">=</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;cross&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ipol</span><span class="p">,</span> <span class="n">ipol</span>

        <span class="k">if</span> <span class="n">pol1</span> <span class="o">==</span> <span class="n">pol2</span><span class="p">:</span>
            <span class="n">ipol1</span> <span class="o">=</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pol1</span><span class="p">)</span>
            <span class="n">ipol2</span> <span class="o">=</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pol2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipol1</span> <span class="o">=</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pol2</span><span class="p">)</span>
            <span class="n">ipol2</span> <span class="o">=</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pol1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ipol1</span><span class="p">,</span> <span class="n">ipol2</span></div>



<div class="viewcode-block" id="HolographyTransitFit">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.HolographyTransitFit">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HolographyTransitFit</span><span class="p">(</span><span class="n">TransitFit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fit a model to the transit.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : str</span>
<span class="sd">        Name of the model to fit.  One of &#39;gauss_amp_poly_phase&#39; or</span>
<span class="sd">        &#39;poly_log_amp_poly_phase&#39;.</span>
<span class="sd">    nsigma : float</span>
<span class="sd">        Number of standard deviations away from transit to fit.</span>
<span class="sd">    absolute_sigma : bool</span>
<span class="sd">        Set to True if the errors provided are absolute.  Set to False if</span>
<span class="sd">        the errors provided are relative, in which case the parameter covariance</span>
<span class="sd">        will be scaled by the chi-squared per degree-of-freedom.</span>
<span class="sd">    poly_type : str</span>
<span class="sd">        Type of polynomial.  Either &#39;standard&#39;, &#39;hermite&#39;, or &#39;chebychev&#39;.</span>
<span class="sd">    poly_deg_amp : int</span>
<span class="sd">        Degree of the polynomial to fit to amplitude.</span>
<span class="sd">        Relevant if `poly = True`.</span>
<span class="sd">    poly_deg_phi : int</span>
<span class="sd">        Degree of the polynomial to fit to phase.</span>
<span class="sd">        Relevant if `poly = True`.</span>
<span class="sd">    niter : int</span>
<span class="sd">        Number of times to update the errors using model amplitude.</span>
<span class="sd">        Relevant if `poly = True`.</span>
<span class="sd">    moving_window : int</span>
<span class="sd">        Number of standard deviations away from peak to fit.</span>
<span class="sd">        The peak location is updated with each iteration.</span>
<span class="sd">        Must be less than `nsigma`.  Relevant if `poly = True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Disable NaN checks by default since they can be valid outputs of the fit</span>
    <span class="n">nan_check</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proptype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">nan_skip</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proptype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">nan_dump</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proptype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<div class="viewcode-block" id="HolographyTransitFit.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.HolographyTransitFit.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform the fit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transit: TrackBeam</span>
<span class="sd">            Transit to be fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit: TransitFitParams</span>
<span class="sd">            Fit parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transit</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># Set initial estimate of beam sigma</span>
        <span class="n">local_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
            <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">local_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">local_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">local_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">ninput</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">local_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="n">local_slice</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span> <span class="o">*</span> <span class="n">SPEED_LIGHT</span> <span class="o">/</span> <span class="p">(</span><span class="n">CHIME_CYL_W</span> <span class="o">*</span> <span class="n">freq</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">360.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">ninput</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sigma</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Find index into pol axis that yields copolar products</span>
        <span class="n">pol_axis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="s2">&quot;pol&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;co&quot;</span> <span class="ow">in</span> <span class="n">pol_axis</span><span class="p">:</span>
            <span class="n">copolar_slice</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;co&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">this_pol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">ii</span> <span class="o">//</span> <span class="mi">256</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">pol_axis</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ninput</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">copolar_slice</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">this_pol</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ninput</span><span class="p">))</span>

        <span class="c1"># Dereference datasets</span>
        <span class="n">ha</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">pix</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">][:]</span>

        <span class="n">vis</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="p">[</span><span class="n">copolar_slice</span><span class="p">]</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">invert_no_zero</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="n">copolar_slice</span><span class="p">]))</span>

        <span class="c1"># Flag data that is outside the fit window set by nsigma config parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">*=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ha</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
                <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Instantiate the model fitter</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelClass</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span><span class="p">)</span>

        <span class="c1"># Fit the model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_kwargs</span><span class="p">)</span>

        <span class="c1"># Pack into container</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">TransitFitParams</span><span class="p">(</span>
            <span class="n">param</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">parameter_names</span><span class="p">,</span>
            <span class="n">component</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">component</span><span class="p">,</span>
            <span class="n">axes_from</span><span class="o">=</span><span class="n">transit</span><span class="p">,</span>
            <span class="n">attrs_from</span><span class="o">=</span><span class="n">transit</span><span class="p">,</span>
            <span class="n">distributed</span><span class="o">=</span><span class="n">transit</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
            <span class="n">comm</span><span class="o">=</span><span class="n">transit</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">fit</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="s2">&quot;chisq&quot;</span><span class="p">)</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="s2">&quot;ndof&quot;</span><span class="p">)</span>

        <span class="n">fit</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

        <span class="c1"># Transfer fit information to container attributes</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;model_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model_kwargs</span><span class="p">)</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;model_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelClass</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="c1"># Save datasets</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">parameter</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">param</span><span class="p">[:]</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">parameter_cov</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">param_cov</span><span class="p">[:]</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">chisq</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span><span class="p">[:]</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">ndof</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ndof</span><span class="p">[:]</span>

        <span class="k">return</span> <span class="n">fit</span></div>
</div>



<div class="viewcode-block" id="ApplyHolographyGains">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.ApplyHolographyGains">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ApplyHolographyGains</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply gains to a holography transit.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    overwrite: bool (default: False)</span>
<span class="sd">        If True, overwrite the input TrackBeam.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">overwrite</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="ApplyHolographyGains.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.ApplyHolographyGains.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_in</span><span class="p">,</span> <span class="n">gain</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply gain.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        track_in: draco.core.containers.TrackBeam</span>
<span class="sd">            Holography track to apply gains to. Will apply gains to</span>
<span class="sd">            track[&#39;beam&#39;], expecting axes to be freq, pol, input, ha</span>
<span class="sd">        gain: np.array</span>
<span class="sd">            Gain to apply. Expected axes are freq, pol, and input</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        track: draco.core.containers.TrackBeam</span>
<span class="sd">            Holography track with gains applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">track_in</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">TrackBeam</span><span class="p">(</span>
                <span class="n">axes_from</span><span class="o">=</span><span class="n">track_in</span><span class="p">,</span>
                <span class="n">attrs_from</span><span class="o">=</span><span class="n">track_in</span><span class="p">,</span>
                <span class="n">distributed</span><span class="o">=</span><span class="n">track_in</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span>
                <span class="n">comm</span><span class="o">=</span><span class="n">track_in</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">track</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_in</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][:]</span>
            <span class="n">track</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_in</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][:]</span>

        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][:]</span> <span class="o">*=</span> <span class="n">gain</span><span class="o">.</span><span class="n">gain</span><span class="p">[:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][:]</span> <span class="o">*=</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gain</span><span class="o">.</span><span class="n">gain</span><span class="p">[:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)[</span>
            <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span>
        <span class="p">]</span>

        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][:]),</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">track</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][:]),</span> <span class="n">track</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">][:],</span> <span class="mi">0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">track</span></div>
</div>



<div class="viewcode-block" id="TransitStacker">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitStacker">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransitStacker</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">SingleTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stack a number of transits together.</span>

<span class="sd">    The weights will be inverted and stacked as variances. The variance</span>
<span class="sd">    between transits is evaluated and recorded in the output container.</span>

<span class="sd">    All transits should be on a common grid in hour angle.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    weight: str (default: uniform)</span>
<span class="sd">        The weighting to use in the stack. One of `uniform` or `inverse_variance`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">enum</span><span class="p">([</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;inverse_variance&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="TransitStacker.setup">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitStacker.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise internal variables.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="TransitStacker.process">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitStacker.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a transit to the stack.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transit: draco.core.containers.TrackBeam</span>
<span class="sd">            A holography transit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing transit stack.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">TrackBeam</span><span class="p">(</span>
                <span class="n">axes_from</span><span class="o">=</span><span class="n">transit</span><span class="p">,</span> <span class="n">distributed</span><span class="o">=</span><span class="n">transit</span><span class="o">.</span><span class="n">distributed</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">transit</span><span class="o">.</span><span class="n">comm</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="s2">&quot;sample_variance&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="s2">&quot;nsample&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">redistribute</span><span class="p">(</span><span class="s2">&quot;freq&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to stack.&quot;</span><span class="p">)</span>

            <span class="c1"># Copy over relevant attributes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;observation_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;observation_id&quot;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;transit_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;transit_time&quot;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;archivefiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;archivefiles&quot;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;source_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;source_name&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;icrs_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;icrs_ra&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cirs_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;cirs_ra&quot;</span><span class="p">]</span>

            <span class="c1"># Copy data for first transit</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="s2">&quot;inverse_variance&quot;</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">nsample</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">coeff</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Transit has different shape than stack: </span><span class="si">{</span><span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Skipping.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to stack.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;observation_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;observation_id&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;transit_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;transit_time&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;archivefiles&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;archivefiles&quot;</span><span class="p">])</span>

            <span class="c1"># Accumulate transit data</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="s2">&quot;inverse_variance&quot;</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">coeff</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">weight</span><span class="p">[:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">nsample</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">flag</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">transit</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">+=</span> <span class="n">coeff</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="TransitStacker.process_finish">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.TransitStacker.process_finish">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalise the stack and return the result.</span>

<span class="sd">        Includes the sample variance over transits within the stack.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stack: draco.core.containers.TrackBeam</span>
<span class="sd">            Stacked transits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Divide by norm to get average transit</span>
        <span class="n">inv_norm</span> <span class="o">=</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">*=</span> <span class="n">inv_norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">invert_no_zero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">weight</span><span class="p">[:])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="o">**</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">*</span> <span class="n">inv_norm</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="p">[:])</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span> <span class="o">*</span> <span class="n">inv_norm</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">beam</span><span class="p">[:]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Calculate the covariance between the real and imaginary component</span>
        <span class="c1"># from the accumulated variance and psuedo-variance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">sample_variance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span><span class="o">.</span><span class="n">real</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">sample_variance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span><span class="o">.</span><span class="n">imag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">sample_variance</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_variance</span><span class="o">.</span><span class="n">real</span>
        <span class="p">)</span>

        <span class="c1"># Create tag</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;transit_time&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_to_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;source_name&quot;</span><span class="p">],</span>
            <span class="n">unix_to_datetime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">),</span>
            <span class="n">unix_to_datetime</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span></div>
</div>



<div class="viewcode-block" id="FilterHolographyProcessed">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.FilterHolographyProcessed">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FilterHolographyProcessed</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">MPILoggedTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter holography transit DataIntervals produced by `io.QueryDatabase`.</span>

<span class="sd">    Excludes DataIntervals which are already processed.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    processed_dir: str or list of str</span>
<span class="sd">        Directory or list of directories to look in for processed files.</span>
<span class="sd">    source: str</span>
<span class="sd">        The name of the holography source (as used in the holography database).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span>
        <span class="n">proptype</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Property</span><span class="p">(</span><span class="n">proptype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<div class="viewcode-block" id="FilterHolographyProcessed.setup">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.FilterHolographyProcessed.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of existing processed files.&quot;&quot;&quot;</span>
        <span class="c1"># Find processed transit files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proc_transits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">processed_dir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for processed transits in </span><span class="si">{</span><span class="n">processed_dir</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="c1"># Expand path</span>
            <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">)</span>
            <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">processed_files</span> <span class="o">=</span> <span class="n">listdir</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">processed_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">processed_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">with</span> <span class="n">ContainerBase</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">ondisk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">distributed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">obs_id</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;observation_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">obs_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">proc_transits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proc_transits</span><span class="p">)</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> processed transits.&quot;</span><span class="p">)</span>

        <span class="c1"># Query database for observations of this source</span>
        <span class="n">hol_obs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mpiutil</span><span class="o">.</span><span class="n">rank0</span><span class="p">:</span>
            <span class="n">hol_obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_holography_obs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hol_obs</span> <span class="o">=</span> <span class="n">mpiutil</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">hol_obs</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mpiutil</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span></div>


<div class="viewcode-block" id="FilterHolographyProcessed.next">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.FilterHolographyProcessed.next">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intervals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter input files to exclude those already processed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        intervals: list of chimedb.data_index.DataInterval</span>
<span class="sd">            List intervals to filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        files: list of str</span>
<span class="sd">            List of files to be processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting next for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">fi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># find holography observation that overlaps this set</span>
            <span class="n">this_obs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">o</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hol_obs</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">finish_time</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">finish_time</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">o</span><span class="o">.</span><span class="n">finish_time</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_obs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not find source transit in holography database for </span><span class="si">{</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">this_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proc_transits</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Already processed transit for </span><span class="si">{</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">+=</span> <span class="n">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaving next for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span></div>
</div>



<div class="viewcode-block" id="unwrap_lha">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.unwrap_lha">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unwrap_lha</span><span class="p">(</span><span class="n">lsa</span><span class="p">,</span> <span class="n">src_ra</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert LSA into HA for a source&#39;s RA. Ensures HA is monotonically increasing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lsa: array</span>
<span class="sd">        Local sidereal angle.</span>
<span class="sd">    src_ra: float</span>
<span class="sd">        The RA of the source.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ha: array</span>
<span class="sd">        Hour angle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ensure monotonic</span>
    <span class="n">start_lsa</span> <span class="o">=</span> <span class="n">lsa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lsa</span> <span class="o">-=</span> <span class="n">start_lsa</span>
    <span class="n">lsa</span><span class="p">[</span><span class="n">lsa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">360.0</span>
    <span class="n">lsa</span> <span class="o">+=</span> <span class="n">start_lsa</span>
    <span class="c1"># subtract source RA</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lsa</span> <span class="o">-</span> <span class="n">src_ra</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lsa</span> <span class="o">-</span> <span class="p">(</span><span class="n">src_ra</span> <span class="o">+</span> <span class="mf">360.0</span><span class="p">)),</span>
        <span class="n">lsa</span> <span class="o">-</span> <span class="n">src_ra</span><span class="p">,</span>
        <span class="n">lsa</span> <span class="o">-</span> <span class="n">src_ra</span> <span class="o">-</span> <span class="mf">360.0</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_holography_obs">
<a class="viewcode-back" href="../../../_autosummary/ch_pipeline.analysis.beam.html#ch_pipeline.analysis.beam.get_holography_obs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_holography_obs</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query database for list of all holography observations for the given source.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src: str</span>
<span class="sd">        Source name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    db_obs: list of ch_util.holography.HolographyObservation</span>
<span class="sd">        Observations of this source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connect_database</span><span class="p">()</span>
    <span class="n">db_src</span> <span class="o">=</span> <span class="n">holography</span><span class="o">.</span><span class="n">HolographySource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">holography</span><span class="o">.</span><span class="n">HolographySource</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">src</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">holography</span><span class="o">.</span><span class="n">HolographyObservation</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">holography</span><span class="o">.</span><span class="n">HolographyObservation</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">db_src</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, CHIME collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>